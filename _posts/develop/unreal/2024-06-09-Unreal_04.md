---
layout: post
title:  "[Unreal] 04.탱크 게임"
excerpt : ""
categories: develop
tags: cpp unreal
toc: true
comments : true
use_math : true

date: 2024-06-09
last_modified_at: 2024-06-13
---
> <span style="font-size: 80%">
본 문서는 어소트락 언리얼엔진 게임프로그래머 양성과정의 강의를 토대로 필기한 내용입니다 </span>

<!--more-->

* this unordered seed list will be replaced by the toc
{:toc}

# 탱크게임
- w,s 누르면 -> 탱크 이동
- a,d 누르면 -> 탱크 좌우 회전
- 마우스 좌우회전 -> 헤드 좌우 회전
- 마우스 상하회전 -> 포신 상하 회전
- 마우스 왼쪽클릭 -> 불렛 발사
- 스킬 마우스 1번 -> 불렛 3발 동시 발사
- 일정 시간에 한 번씩 -> 불렛 5발 발사

## 메쉬 & 카메라
> C++ 클래스로 만들기 위해 Mesh를 직접 생성하고 상속 구조의 경우 상대 위치와 상대 스케일을 통해 배치를 한다   
> 필요에 따라 스태틱 메쉬를 여러 개 만들어 두고 Pivot 변경도 가능하다

### PlayerPawn.h
```cpp
#pragma once

#include "../GameInfo.h"
#include "GameFramework/Pawn.h"
#include "PlayerPawn.generated.h"

UCLASS()
class STUDY_240601_API APlayerPawn : public APawn
{
	GENERATED_BODY()

public:
	APlayerPawn();

	UPROPERTY(VisibleAnywhere)
	TObjectPtr<UStaticMeshComponent> mBodyMesh;

	UPROPERTY(VisibleAnywhere)
	TObjectPtr<UStaticMeshComponent> mHeadMesh;

	UPROPERTY(VisibleAnywhere)
	TObjectPtr<UStaticMeshComponent> mBarrelMesh;

	UPROPERTY(VisibleAnywhere)
	TObjectPtr<USpringArmComponent> mArm;

	UPROPERTY(VisibleAnywhere)
	TObjectPtr<UCameraComponent> mCamera;

    ...

};
```

### PlayerPawn.cpp

```cpp
#include "PlayerPawn.h"
#include "../Input/TankInputData.h"
#include "EnhancedInputSubsystems.h"
#include "EnhancedInputComponent.h"
#include "../Skill/ShieldActor.h"

APlayerPawn::APlayerPawn()
{
	PrimaryActorTick.bCanEverTick = true;

	mBodyMesh = CreateDefaultSubobject<UStaticMeshComponent>(TEXT("BodyMesh"));
	SetRootComponent(mBodyMesh);

	static ConstructorHelpers::FObjectFinder<UStaticMesh>BodyMeshAsset(TEXT("/Script/Engine.StaticMesh'/Game/Test/Body.Body'"));
	if (BodyMeshAsset.Succeeded()) mBodyMesh->SetStaticMesh(BodyMeshAsset.Object);

	// Create the HeadMesh component and attach it to the BodyMesh
	mHeadMesh = CreateDefaultSubobject<UStaticMeshComponent>(TEXT("HeadMesh"));
	mHeadMesh->SetupAttachment(mBodyMesh);

	// Load the Head Mesh
	static ConstructorHelpers::FObjectFinder<UStaticMesh> HeadMeshAsset(TEXT("/Script/Engine.StaticMesh'/Game/Test/Head.Head'"));
	if (HeadMeshAsset.Succeeded())
	{
		mHeadMesh->SetStaticMesh(HeadMeshAsset.Object);
	}

	// Create the BarrelMesh component and attach it to the HeadMesh
	mBarrelMesh = CreateDefaultSubobject<UStaticMeshComponent>(TEXT("BarrelMesh"));
	mBarrelMesh->SetupAttachment(mHeadMesh);

	// Load the Barrel Mesh
	static ConstructorHelpers::FObjectFinder<UStaticMesh> BarrelMeshAsset(TEXT("/Script/Engine.StaticMesh'/Game/Test/Barrel.Barrel'"));
	if (BarrelMeshAsset.Succeeded())
	{
		mBarrelMesh->SetStaticMesh(BarrelMeshAsset.Object);
	}

	mMuzzle = CreateDefaultSubobject<USceneComponent>(TEXT("Muzzle"));
	mMuzzle->SetupAttachment(mBarrelMesh);

	// 메쉬 위치 및 스케일 조정
	mBodyMesh->SetWorldScale3D(FVector(2.0, 2.0, 1.0));
	mHeadMesh->SetRelativeScale3D(FVector(0.5, 0.5, 1.0));
	mHeadMesh->SetRelativeLocation(FVector(0.0, 0.0, 100));
	mBarrelMesh->SetRelativeScale3D(FVector(2.0, 0.25, 0.25));
	mBarrelMesh->SetRelativeLocation(FVector(50, 0, 0));
	mMuzzle->SetRelativeLocation(FVector(105.0, 0, 0));

	// 스프링암 & 카메라
	mArm = CreateDefaultSubobject<USpringArmComponent>(TEXT("Arm"));
	mCamera = CreateDefaultSubobject<UCameraComponent>(TEXT("Camera"));

	mArm->SetupAttachment(mBodyMesh); // SpringArm은 RootComponent의 자식으로 붙여주고
	mCamera->SetupAttachment(mArm); // Camera는 SpringArm의 자식으로 붙여준다

	mArm->TargetArmLength = 500.f;
	mArm->SetRelativeLocation(FVector(0.0, 0.0, 80.0));
	mArm->SetRelativeRotation(FRotator(-30.0f, 0.0, 0.0));
}
```

## 게임모드

### DefaultGameMode.cpp
```cpp
#include "DefaultGameMode.h"
#include "../Player/PlayerCharacter.h"
#include "../Player/PlayerPawn.h"

ADefaultGameMode::ADefaultGameMode()
{
	DefaultPawnClass = nullptr; // DefaultPawn이 없음으로 처리
}
```

## 입력
> 탱크의 InputData를 새로 만들고 MappingContext도 다시 매핑하여 사용

### TankInputData.h

```cpp
#pragma once

#include "../GameInfo.h"
#include "InputMappingContext.h"
#include "InputAction.h"
#include "UObject/NoExportTypes.h"
#include "TankInputData.generated.h"

UCLASS()
class STUDY_240601_API UTankInputData : public UObject
{
	GENERATED_BODY()

public:
	UTankInputData();

public:
	UInputMappingContext* mTankContext = nullptr; // 선언 및 초기화

public:
	UInputAction* mMove = nullptr;
	UInputAction* mAttack = nullptr;
	UInputAction* mShield = nullptr;
	UInputAction* mRotation = nullptr;
};

```

### TankInputData.cpp

```cpp
// Fill out your copyright notice in the Description page of Project Settings.


#include "TankInputData.h"

UTankInputData::UTankInputData()
{
	static ConstructorHelpers::FObjectFinder<UInputMappingContext>Context(TEXT("/Script/EnhancedInput.InputMappingContext'/Game/Test/Input/IMC_Tank.IMC_Tank'"));

	if (Context.Succeeded()) mTankContext = Context.Object;

	static ConstructorHelpers::FObjectFinder<UInputAction>Move(TEXT("/Script/EnhancedInput.InputAction'/Game/Test/Input/IA_Move.IA_Move'"));

	if (Move.Succeeded()) mMove = Move.Object;

	static ConstructorHelpers::FObjectFinder<UInputAction>Rotation(TEXT("/Script/EnhancedInput.InputAction'/Game/Test/Input/IA_Rotation.IA_Rotation'"));

	if (Rotation.Succeeded()) mRotation = Rotation.Object;
}
```

## 이동
- `bUseControllerRotationYaw` : true 일때, 폰의 Yaw가 컨트롤러 Yaw 로테이션과 매칭된다

<p align = "center">
    <img src = "https://github.com/Jinlee0206/Jinlee0206.github.io/assets/105345909/e6766365-9ea2-48f5-811d-0577c16e414d" width = 320>
</p>

### PlayerPawn.h
```cpp
#pragma once

#include "../GameInfo.h"
#include "InputActionValue.h"
#include "GameFramework/Pawn.h"
#include "PlayerPawn.generated.h"

UCLASS()
class STUDY_240601_API APlayerPawn : public APawn
{
	GENERATED_BODY()

public:
	// Sets default values for this pawn's properties
	APlayerPawn();

	UPROPERTY(VisibleAnywhere)
	TObjectPtr<UStaticMeshComponent> mBodyMesh;

	UPROPERTY(VisibleAnywhere)
	TObjectPtr<UStaticMeshComponent> mHeadMesh;

	UPROPERTY(VisibleAnywhere)
	TObjectPtr<UStaticMeshComponent> mBarrelMesh;

	UPROPERTY(VisibleAnywhere)
	TObjectPtr<USceneComponent> mMuzzle; // 공격 지점 씬 컴포넌트(빈 게임 오브젝트의 개념)

	UPROPERTY(VisibleAnywhere)
	TObjectPtr<UFloatingPawnMovement> mMovement; // 이동을 위해 PlayerPawn 클래스에 FloatingPawnMovement 컴포넌트 추가

	UPROPERTY(VisibleAnywhere)
	TObjectPtr<USpringArmComponent> mArm;

	UPROPERTY(VisibleAnywhere)
	TObjectPtr<UCameraComponent> mCamera;


protected:
	// Called when the game starts or when spawned
	virtual void BeginPlay() override;

public:	
	// Called every frame
	virtual void Tick(float DeltaTime) override;

	// Called to bind functionality to input
	virtual void SetupPlayerInputComponent(class UInputComponent* PlayerInputComponent) override;


protected:
	void OnMove(const FInputActionValue& InputValue);
	void OnRotation(const FInputActionValue& InputValue);
};
```


## 회전


## 공격
> Muzzle을 씬 컴포넌트로 하나 만들어서 캐논의 자식으로 상속 -> 캐논 움직임에 따라 함께 움직인다

```cpp
```

### Bullet.h
- `UStaticMeshComponent` : 불렛의 메쉬를 위한
- `UProjectileMovementComponent` : 투사체 발사를 위함
- Collision Event
  - `OnProjectileStop()`
  - `Hit Result 구조체`
    - 부딪힌 물체의 종류, 벡터, 크기, 속도 등 저장하는 구조체
- 델리게이트에 등록할 함수는 반드시 UFUNCTION()을 붙여주어야 한다
-  Unreal -> **컴포넌트가 아닌 액터를 제거 해야한다**

## 이펙트
- 케스케이드 시스템 (레거시)
- 나이아가라 시스템 